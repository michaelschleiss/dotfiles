#!/usr/bin/env bash

script_dir="$(cd $(dirname "${BASH_SOURCE[0]}") && pwd)"
dry="0"

while [[ $# > 0 ]]; do
    if [[ "$1" == "--dry" ]]; then
        dry="1"
    fi
    shift
done

log() {
    if [[ $dry == "1" ]]; then
        echo "[DRY_RUN]: $@"
    else
        echo "$@"
    fi
}

execute() {
    log "execute: $@"
    if [[ $dry == "1" ]]; then
        return
    fi

    "$@"
}

log "----------- dev-env ----------"

cd $script_dir
copy_dir() {
  from=$1
  to=$2

  for dir in "$from"/*/; do
    name=$(basename "$dir")
    if [[ "$name" == "serena" ]]; then
      # Template: only copy if not exists
      execute rsync -a --ignore-existing "$dir" "$to/$name/"
    elif [[ "$name" == "claude" || "$name" == "codex" || "$name" == "gh" ]]; then
      # No --delete: preserve local state (.claude.json is managed by runs/ai)
      execute rsync -a --exclude='.claude.json*' "$dir" "$to/$name/"
    else
      execute rsync -a --delete "$dir" "$to/$name/"
    fi
  done
}

copy_file() {
  from=$1
  to=$2
  name=$(basename $from)
  execute rm $to/$name
  execute cp $from $to/$name
}

copy_dir config  ${XDG_CONFIG_HOME:-$HOME/.config}
copy_dir local   ${XDG_HOME:-$HOME/.local}
copy_file env/.fdignore $HOME

# Serena defaults: ensure a non-empty config exists at the legacy path (~/.serena)
serena_src="$script_dir/config/serena/serena_config.yml"
serena_dst="$HOME/.serena/serena_config.yml"
if [[ -f "$serena_src" ]]; then
  if [[ ! -s "$serena_dst" ]]; then
    execute mkdir -p "$HOME/.serena"
    execute cp "$serena_src" "$serena_dst"
  fi
fi

log "Configuring git to use global ignore"
execute git config --global core.excludesfile ~/.config/git/ignore
log "Git global ignore configured"

# Copy Claude commands to global location
log "Installing Claude commands globally"
if [[ -d "$script_dir/config/claude/commands" ]]; then
  execute mkdir -p "$HOME/.claude/commands"

  # Backup existing commands if present
  if [[ -d "$HOME/.claude/commands" ]] && [[ "$(ls -A "$HOME/.claude/commands" 2>/dev/null)" ]]; then
    backup_dir="$HOME/.claude/commands.backup.$(date +%Y%m%d%H%M%S)"
    execute cp -r "$HOME/.claude/commands" "$backup_dir"
    log "Backed up existing commands to $backup_dir"
  fi

  for cmd in "$script_dir/config/claude/commands"/*; do
    if [[ -f "$cmd" ]]; then
      execute cp "$cmd" "$HOME/.claude/commands/"
      # Only chmod +x for non-markdown files (actual scripts)
      if [[ "$cmd" != *.md ]]; then
        execute chmod +x "$HOME/.claude/commands/$(basename "$cmd")"
      fi
    fi
  done
  log "Claude commands installed to ~/.claude/commands/"
fi
