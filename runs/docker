#!/usr/bin/env bash
set -euo pipefail

# Docker and DevPod installation

log() {
  echo "[docker] $*"
}

os_name="$(uname -s)"

ensure_docker_group() {
  if [[ "$(uname -s)" == "Linux" ]]; then
    if command -v getent >/dev/null 2>&1; then
      if ! getent group docker >/dev/null 2>&1; then
        log "docker group not found; skipping group setup"
        return 0
      fi
    fi

    if ! groups "$USER" | grep -qw docker; then
      log "Adding $USER to docker group"
      sudo usermod -aG docker "$USER"
      log "Logout and login for group changes to take effect (or run: newgrp docker)"
    else
      log "$USER already in docker group"
    fi
  fi
}

# ============ Docker Installation ============

if command -v docker &>/dev/null; then
  log "Docker already installed"
  docker --version
  ensure_docker_group
else
  if [[ "$os_name" == "Darwin" ]]; then
    log "Installing Docker Desktop (brew cask)"
    brew install --cask docker

  elif [[ "$os_name" == "Linux" ]]; then
    log "Installing Docker"

    # Install dependencies
    sudo apt update -qq
    sudo apt install -qq -y ca-certificates curl gnupg

    # Add Docker's official GPG key
    sudo install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    sudo chmod a+r /etc/apt/keyrings/docker.gpg

    # Add the repository
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

    # Install Docker
    sudo apt update -qq
    sudo apt install -qq -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    ensure_docker_group
  fi
fi

# ============ DevPod Installation ============

if command -v devpod &>/dev/null; then
  log "DevPod already installed"
  devpod version
else
  if [[ "$os_name" == "Darwin" ]]; then
    log "Installing DevPod (brew cask)"
    brew install --cask devpod

  elif [[ "$os_name" == "Linux" ]]; then
    log "Installing DevPod CLI"

    # Detect architecture
    arch=$(uname -m)
    if [[ "$arch" == "x86_64" ]]; then
      arch_suffix="amd64"
    elif [[ "$arch" == "aarch64" || "$arch" == "arm64" ]]; then
      arch_suffix="arm64"
    else
      log "Unsupported architecture: $arch"
      exit 1
    fi

    # Download and install DevPod CLI
    curl -L -o devpod "https://github.com/loft-sh/devpod/releases/latest/download/devpod-linux-${arch_suffix}"
    sudo install -c -m 0755 devpod /usr/local/bin
    rm -f devpod

    log "DevPod installed successfully"
    devpod version
  fi
fi

log "Installation complete"
