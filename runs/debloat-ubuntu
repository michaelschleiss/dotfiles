#!/usr/bin/env bash
set -euo pipefail

# Remove Ubuntu desktop bloat

log() {
  echo "[debloat] $*"
}

# Remove packages quietly, showing only real errors
# NOTE: Do NOT use --auto-remove here - it causes cascading removals of
# important dependencies. Only remove what is explicitly listed.
apt_remove() {
  sudo DEBIAN_FRONTEND=noninteractive apt-get remove -qq -y "$@" 2>&1 \
    | grep -Ev "(is not installed|Unable to locate package)" \
    || true
}

os_name="$(uname -s)"

if [[ "$os_name" != "Linux" ]]; then
  log "Only for Linux, skipping"
  exit 0
fi

# Clean up leftover /snap from previous run (after reboot)
if [[ -d /snap ]] && ! mount | grep -q '/snap'; then
  log "Cleaning leftover /snap directory"
  sudo rm -rf /snap
fi

log "Marking essential packages as manual (prevents cascade removal)"
# Audio/Video stack (needed by most desktops)
sudo apt-mark manual pipewire pipewire-pulse wireplumber 2>/dev/null || true
# Bluetooth
sudo apt-mark manual blueman 2>/dev/null || true
# Key libraries that tend to get orphaned
sudo apt-mark manual \
  python3-pil python3-pexpect \
  gstreamer1.0-plugins-good gstreamer1.0-plugins-base \
  libprotobuf32t64 libharfbuzz-icu0 \
  usb-modeswitch \
  2>/dev/null || true
# If using Sway/Wayland with nvidia
sudo apt-mark manual \
  libnvidia-egl-wayland1 libnvidia-egl-gbm1 \
  2>/dev/null || true

log "Removing all snaps"
if command -v snap &> /dev/null; then
  # Keep removing snaps until none left (handles dependencies)
  while snaps=$(snap list 2>/dev/null | awk 'NR>1 {print $1}') && [[ -n "$snaps" ]]; do
    for snap_pkg in $snaps; do
      log "Removing snap: $snap_pkg"
      sudo snap remove --purge "$snap_pkg" 2>/dev/null || true
    done
  done
fi

log "Stopping snapd services"
sudo systemctl stop snapd.service snapd.socket snapd.seeded.service 2>/dev/null || true
sudo systemctl disable snapd.service snapd.socket snapd.seeded.service 2>/dev/null || true

log "Unmounting snap filesystems"
for mnt in $(mount | grep '/snap' | awk '{print $3}' | sort -r); do
  sudo umount -l "$mnt" 2>/dev/null || true
done

log "Removing snapd package"
apt_remove snapd
# NOTE: Don't remove gir1.2-snapd-2 or libsnapd-glib-2-1!
# These are dependencies of update-manager, which is a dependency of ubuntu-desktop.
# Removing them triggers a cascade that removes pipewire, gdm3, gnome-shell, cups, etc.

log "Cleaning up snap directories"
rm -rf ~/snap 2>/dev/null || true
sudo rm -rf /var/snap 2>/dev/null || true
sudo rm -rf /var/lib/snapd 2>/dev/null || true
sudo rm -rf /var/cache/snapd 2>/dev/null || true
# /snap may have zombie mounts - check and remove if clear
if mount | grep -q '/snap'; then
  log "Note: /snap has zombie mounts, will be cleaned after reboot"
else
  sudo rm -rf /snap 2>/dev/null || true
fi

log "Cleaning up snap systemd units"
sudo rm -f /etc/systemd/system/snap-*.mount
sudo rm -f /etc/systemd/system/snap.mount

log "Cleaning up snap AppArmor profiles"
sudo rm -f /etc/apparmor.d/*snap*

log "Reloading systemd"
sudo systemctl daemon-reload
sudo systemctl reset-failed

log "Blocking snap reinstall"
sudo tee /etc/apt/preferences.d/nosnap.pref > /dev/null << 'EOF'
Package: snapd
Pin: release a=*
Pin-Priority: -10
EOF

log "Removing games"
apt_remove aisleriot gnome-mines gnome-sudoku gnome-mahjongg gnome-2048

log "Removing default apps"
apt_remove thunderbird rhythmbox shotwell cheese totem remmina \
  transmission-gtk deja-dup gnome-calendar gnome-contacts libreoffice-*

log "Removing GNOME extras"
apt_remove gnome-characters gnome-clocks gnome-font-viewer gnome-logs \
  gnome-initial-setup gnome-user-docs gnome-text-editor yelp

log "Removing accessibility tools"
apt_remove brltty orca speech-dispatcher

log "Removing telemetry"
apt_remove apport apport-gtk whoopsie ubuntu-report popularity-contest

log "Disabling unnecessary boot services"
# NetworkManager-wait-online just blocks boot until network is up - not needed for desktop
sudo systemctl disable NetworkManager-wait-online.service &>/dev/null || true

log "Removing unused XDG directories"
rmdir ~/Desktop ~/Documents ~/Pictures ~/Public ~/Templates ~/Music ~/Videos 2>/dev/null || true
mkdir -p ~/.config
echo "enabled=false" > ~/.config/user-dirs.conf

# NOTE: We intentionally do NOT run apt autoremove here.
# autoremove can cascade and remove important packages that were pulled in
# as dependencies of things we want to keep (like sway, pipewire, etc.)
# Run 'sudo apt autoremove' manually AFTER reviewing what it would remove:
#   apt list --installed | grep ",automatic" | less
#   sudo apt autoremove --dry-run

log "Done"
log "Note: Run 'sudo apt autoremove --dry-run' to review orphaned packages before removing"
