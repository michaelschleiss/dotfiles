#!/usr/bin/env bash
set -euo pipefail

# Git configuration, SSH key setup, and GitHub integration

log() {
  echo "[git] $*"
}

os_name="$(uname -s)"
GIT_NAME="Michael Schleiss"
GIT_EMAIL="michael.schleiss@skd.systems"

# --- Install GitHub CLI ---
if command -v gh &>/dev/null; then
  log "GitHub CLI already installed"
else
  log "Installing GitHub CLI"
  if [[ "$os_name" == "Darwin" ]]; then
    brew install gh
  elif [[ "$os_name" == "Linux" ]]; then
    sudo mkdir -p /etc/apt/keyrings
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
    sudo apt update
    sudo apt install -y gh
  fi
fi

# --- Install GitLab CLI ---
if command -v glab &>/dev/null; then
  log "GitLab CLI already installed"
else
  log "Installing GitLab CLI"
  if [[ "$os_name" == "Darwin" ]]; then
    brew install glab
  elif [[ "$os_name" == "Linux" ]]; then
    curl -fsSL https://gitlab.com/gitlab-org/cli/-/raw/main/scripts/install.sh | sudo sh
  fi
fi

# --- Git config ---
log "Setting git config"
git config --global user.name "$GIT_NAME"
git config --global user.email "$GIT_EMAIL"
git config --global init.defaultBranch main
git config --global pull.rebase false

# --- SSH key ---
SSH_KEY="$HOME/.ssh/id_ed25519"
KEY_CREATED=false

if [[ -f "$SSH_KEY" ]]; then
  log "SSH key already exists: $SSH_KEY"
else
  log "Generating SSH key"
  mkdir -p "$HOME/.ssh"
  ssh-keygen -t ed25519 -C "$GIT_EMAIL" -f "$SSH_KEY" -N ""
  KEY_CREATED=true
fi

# Start ssh-agent and add key
eval "$(ssh-agent -s)" > /dev/null
ssh-add "$SSH_KEY" 2>/dev/null

# --- GitHub auth and SSH key upload ---
if ! gh auth status &>/dev/null; then
  log "Authenticating with GitHub (browser will open)"
  gh auth login -p ssh -h github.com -w
fi

# Add SSH key to GitHub if newly created
if [[ "$KEY_CREATED" == true ]]; then
  log "Adding SSH key to GitHub"
  gh ssh-key add "$SSH_KEY.pub" --title "$(hostname)"
fi

# --- GitLab auth and SSH key upload ---
GITLAB_HOST="gitlab.stark-defence.com"
if ! glab auth status --hostname "$GITLAB_HOST" &>/dev/null; then
  log "Authenticating with GitLab ($GITLAB_HOST)"
  glab auth login --hostname "$GITLAB_HOST"
fi

# Add SSH key to GitLab if newly created
if [[ "$KEY_CREATED" == true ]]; then
  log "Adding SSH key to GitLab"
  glab ssh-key add "$SSH_KEY.pub" --title "$(hostname)" --hostname "$GITLAB_HOST"
fi

log "Done"
