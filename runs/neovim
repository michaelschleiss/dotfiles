#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/lib"

rm -rf ~/neovim
echo "Cloning neovim repository..."
git clone -q git@github.com:neovim/neovim.git ~/neovim
cd ~/neovim
git fetch -q
git checkout -q v0.11.5

os_name="$(uname -s)"

if [[ "$os_name" == "Darwin" ]]; then
  brew install ninja cmake gettext curl
  cores=$(sysctl -n hw.ncpu)
elif [[ "$os_name" == "Linux" ]]; then
  echo "Updating package lists..."
  sudo apt-get update -qq
  echo "Installing build dependencies..."
  sudo apt-get install -qq cmake gettext lua5.1 liblua5.1-0-dev
  echo "Installing plugin dependencies..."
  sudo apt-get install -qq luarocks golang ripgrep fd-find
  echo "Installing lazygit..."
  LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
  curl -Lo /tmp/lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
  tar -xzf /tmp/lazygit.tar.gz -C /tmp lazygit
  sudo install /tmp/lazygit /usr/local/bin
  rm /tmp/lazygit.tar.gz /tmp/lazygit
  echo "Installing Node.js 22 LTS via NodeSource..."
  curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
  sudo apt-get install -qq nodejs
  echo "Installing tree-sitter CLI..."
  source ~/.cargo/env
  cargo install tree-sitter-cli@0.25.0
  ln -sf $(which fdfind) ~/.local/bin/fd
  cores=$(nproc)
else
  echo "Unknown OS: $os_name" >&2
  exit 1
fi

echo "Building neovim..."
make -s CMAKE_BUILD_TYPE=RelWithDebInfo -j${cores}
echo "Installing neovim..."
sudo make -s install

rm -rf ~/neovim

# Shell integration
add_block_to_file "$HOME/.zprofile" "editor" 'export EDITOR=nvim
export VISUAL=nvim'

read -r -d '' ALIASES << 'EOF' || true
alias vim='nvim'
alias inv='nvim $(fd | fzf -m --preview="bat --color=always {}")'
alias ginv='nvim $(fd . ~ | fzf -m --preview="bat --color=always {}")'
EOF
add_block_to_file "$HOME/.zshrc" "nvim-aliases" "$ALIASES"
