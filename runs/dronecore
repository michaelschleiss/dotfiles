#!/usr/bin/env bash
set -euo pipefail

# Dronecore (Jetson) SSH setup - works on macOS and Linux

log() {
  echo "[dronecore] $*"
}

# Function for macOS: enables internet sharing via pfctl then SSHs in
DRONECORE_FUNC_MAC='dronecore() {
  # Auto-detect default internet interface, or use provided argument
  local inet_if="${1:-$(route get default 2>/dev/null | awk "/interface:/ {print \$2}")}"
  if [[ -z "$inet_if" ]]; then
    echo "[dronecore] ERROR: Could not detect internet interface. Pass it as argument: dronecore en0"
    return 1
  fi
  # Check if dronecore is connected
  if ! ifconfig | grep -q "inet 192.168.55"; then
    echo "[dronecore] ERROR: No interface on 192.168.55.x - is dronecore connected?"
    return 1
  fi
  # Enable IP forwarding + NAT with pass rules
  sudo sysctl -w net.inet.ip.forwarding=1 >/dev/null 2>&1
  echo "nat on $inet_if from 192.168.55.0/24 to any -> ($inet_if)
pass from 192.168.55.0/24 to any keep state
pass from any to 192.168.55.0/24 keep state" | sudo pfctl -ef - 2>/dev/null
  echo "[dronecore] NAT enabled on $inet_if"
  # SSH in
  sshpass -p dronecore ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null dcs_user@192.168.55.1
}'

# Function for Linux: enables internet sharing via iptables then SSHs in
DRONECORE_FUNC_LINUX='dronecore() {
  # Check if dronecore is connected
  if ! ip addr | grep -q "inet 192.168.55"; then
    echo "[dronecore] ERROR: No interface on 192.168.55.x - is dronecore connected?"
    return 1
  fi
  # Enable IP forwarding
  sudo sysctl -w net.ipv4.ip_forward=1 >/dev/null 2>&1
  # Add iptables rules (idempotent via -C check)
  sudo iptables -t nat -C POSTROUTING -s 192.168.55.0/24 -j MASQUERADE 2>/dev/null || \
    sudo iptables -t nat -A POSTROUTING -s 192.168.55.0/24 -j MASQUERADE
  sudo iptables -C FORWARD -s 192.168.55.0/24 -j ACCEPT 2>/dev/null || \
    sudo iptables -I FORWARD 1 -s 192.168.55.0/24 -j ACCEPT
  sudo iptables -C FORWARD -d 192.168.55.0/24 -j ACCEPT 2>/dev/null || \
    sudo iptables -I FORWARD 1 -d 192.168.55.0/24 -j ACCEPT
  # SSH in
  sshpass -p dronecore ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null dcs_user@192.168.55.1
}'

os_name="$(uname -s)"

# Install sshpass if needed
if ! command -v sshpass &>/dev/null; then
  log "Installing sshpass"
  if [[ "$os_name" == "Darwin" ]]; then
    brew install hudochenkov/sshpass/sshpass
  elif command -v apt &>/dev/null; then
    sudo apt install -y sshpass
  elif command -v pacman &>/dev/null; then
    sudo pacman -S --noconfirm sshpass
  else
    log "ERROR: Cannot install sshpass, please install manually"
    exit 1
  fi
else
  log "sshpass already installed"
fi

# Determine profile file
if [[ -f "$HOME/.zshrc" ]]; then
  PROFILE="$HOME/.zshrc"
elif [[ -f "$HOME/.zprofile" ]]; then
  PROFILE="$HOME/.zprofile"
elif [[ -f "$HOME/.bash_profile" ]]; then
  PROFILE="$HOME/.bash_profile"
else
  PROFILE="$HOME/.bashrc"
fi

# Add dronecore function to profile
if grep -q "^dronecore()" "$PROFILE" 2>/dev/null; then
  log "dronecore already configured in $PROFILE"
else
  # Remove old alias if present
  sed -i.bak "/^alias dronecore=/d" "$PROFILE" 2>/dev/null || true
  log "Adding dronecore function to $PROFILE"
  echo "" >> "$PROFILE"
  echo "# Dronecore: internet sharing + SSH" >> "$PROFILE"
  if [[ "$os_name" == "Darwin" ]]; then
    echo "$DRONECORE_FUNC_MAC" >> "$PROFILE"
  else
    echo "$DRONECORE_FUNC_LINUX" >> "$PROFILE"
  fi
fi

log "Done! Run 'source $PROFILE' or restart shell, then use: dronecore"
