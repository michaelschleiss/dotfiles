#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/lib"

log() {
  echo "[ai] $*"
}

have() {
  command -v "$1" >/dev/null 2>&1
}

os_name="$(uname -s)"
arch_name="$(uname -m)"

export PATH="${HOME}/.local/bin:${PATH}"

ensure_cmd() {
  local cmd="$1"
  local pkg="${2:-}"

  if have "$cmd"; then
    return 0
  fi

  if [[ -z "${pkg}" ]]; then
    echo "Missing required command: ${cmd}" >&2
    return 1
  fi

  if [[ "$os_name" == "Darwin" ]] && have brew; then
    log "Installing ${pkg} (Homebrew)"
    brew install "$pkg"
    return 0
  fi

  if [[ "$os_name" == "Linux" ]] && have apt-get; then
    log "Installing ${pkg} (apt)"
    sudo apt-get update
    sudo apt-get install -y "$pkg"
    return 0
  fi

  echo "Missing required command: ${cmd} (and no supported package manager found)" >&2
  return 1
}

install_ripgrep() {
  if have rg; then
    return 0
  fi

  if [[ "$os_name" == "Darwin" ]] && have brew; then
    log "Installing ripgrep (Homebrew)"
    brew install ripgrep
    return 0
  fi

  if [[ "$os_name" == "Linux" ]] && have apt-get; then
    log "Installing ripgrep (apt)"
    sudo apt-get update
    sudo apt-get install -y ripgrep
    return 0
  fi

  echo "ripgrep (rg) is required for codex. Install it and re-run this script." >&2
  return 1
}

codex_target() {
  case "${os_name}/${arch_name}" in
    Darwin/arm64 | Darwin/aarch64) echo "aarch64-apple-darwin" ;;
    Darwin/x86_64 | Darwin/amd64) echo "x86_64-apple-darwin" ;;
    Linux/x86_64 | Linux/amd64) echo "x86_64-unknown-linux-musl" ;;
    Linux/arm64 | Linux/aarch64) echo "aarch64-unknown-linux-musl" ;;
    *) return 1 ;;
  esac
}

install_codex_from_github() {
  local target
  target="$(codex_target)" || {
    echo "Unsupported platform for codex: ${os_name} ${arch_name}" >&2
    return 1
  }

  ensure_cmd curl curl
  ensure_cmd tar tar

  local asset="codex-${target}.tar.gz"
  local url="https://github.com/openai/codex/releases/latest/download/${asset}"
  local tmpdir
  tmpdir="$(mktemp -d)"

  local install_dir="${HOME}/.local/bin"
  mkdir -p "${install_dir}"

  local installed_version=""
  if [[ -x "${install_dir}/codex" ]]; then
    installed_version="$("${install_dir}/codex" --version 2>/dev/null | grep -Eo '[0-9]+\\.[0-9]+\\.[0-9]+' | head -n 1 || true)"
  fi

  local latest_version=""
  local release_json=""
  release_json="$(curl -fsSL "https://api.github.com/repos/openai/codex/releases/latest" 2>/dev/null || true)"
  latest_version="$(printf '%s' "${release_json}" | grep -m1 '"tag_name"' | grep -Eo '[0-9]+\\.[0-9]+\\.[0-9]+' | head -n 1 || true)"

  if [[ -n "${installed_version}" && -n "${latest_version}" && "${installed_version}" == "${latest_version}" ]]; then
    log "codex already up to date: ${installed_version}"
    rm -rf "${tmpdir}"
    return 0
  fi

  if [[ -n "${installed_version}" ]]; then
    if [[ -n "${latest_version}" ]]; then
      log "Updating codex: ${installed_version} -> ${latest_version}"
    else
      log "Updating codex (current: ${installed_version})"
    fi
  else
    log "Installing codex"
  fi

  log "Downloading codex (${target})"
  curl -fsSL "${url}" -o "${tmpdir}/${asset}"

  tar -xzf "${tmpdir}/${asset}" -C "${tmpdir}"

  local extracted_bin="${tmpdir}/codex-${target}"
  if [[ ! -f "${extracted_bin}" ]]; then
    rm -rf "${tmpdir}"
    echo "Expected ${extracted_bin} after extracting ${asset}" >&2
    return 1
  fi

  install -m 0755 "${extracted_bin}" "${install_dir}/codex"
  rm -rf "${tmpdir}"
  log "Installed codex to ${install_dir}/codex ($(\"${install_dir}/codex\" --version 2>/dev/null || echo ok))"
}

install_codex() {
  install_ripgrep

  if [[ "$os_name" == "Darwin" ]] && have brew; then
    log "Updating codex (Homebrew cask)"
    brew upgrade --cask codex || brew install --cask codex
    return 0
  fi

  install_codex_from_github
}

install_uv() {
  if have uvx; then
    log "uv already installed: $(uv --version 2>/dev/null || echo ok)"
    return 0
  fi

  log "Installing uv"
  curl -LsSf https://astral.sh/uv/install.sh | sh

  # Source the env to make uv available immediately
  if [[ -f "${HOME}/.local/bin/env" ]]; then
    # shellcheck disable=SC1091
    source "${HOME}/.local/bin/env"
  fi

  if have uvx; then
    log "Installed uv: $(uv --version 2>/dev/null || echo ok)"
    return 0
  fi

  echo "uv installed but 'uvx' is not on PATH; ensure ~/.local/bin is in PATH." >&2
  return 1
}

install_claude_code() {
  if have claude; then
    log "claude already installed: $(claude --version 2>/dev/null | head -n 1 || echo ok)"
    return 0
  fi

  log "Installing Claude Code"
  curl -fsSL https://claude.ai/install.sh | bash

  if have claude; then
    log "Installed claude: $(claude --version 2>/dev/null | head -n 1 || echo ok)"
    return 0
  fi

  echo "Claude Code installation failed" >&2
  return 1
}

main() {
  install_uv
  install_codex
  install_claude_code

  # Shell integration
  add_block_to_file "$HOME/.zsh_profile" "ai-paths" 'export CLAUDE_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/claude"
export CODEX_HOME="${XDG_CONFIG_HOME:-$HOME/.config}/codex"
export SERENA_HOME="${XDG_CONFIG_HOME:-$HOME/.config}/serena"
alias claudey="claude --allow-dangerously-skip-permissions"'

  add_block_to_file "$HOME/.zshrc" "codex-completion" 'if [[ -o interactive ]] && command -v codex >/dev/null 2>&1; then
  if ! whence -w compdef >/dev/null 2>&1; then
    autoload -Uz compinit
    compinit -i
  fi
  if whence -w compdef >/dev/null 2>&1; then
    eval "$(codex completion zsh)"
  fi
fi'

  log "Done"
}

main "$@"
