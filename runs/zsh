#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/lib"

log() {
  echo "[zsh] $*"
}

os_name="$(uname -s)"

# --- Install zsh + plugins (Linux only, macOS has zsh built-in) ---
if [[ "$os_name" == "Linux" ]]; then
  log "Installing zsh and plugins"
  sudo apt-get update -qq
  sudo apt-get install -qq -y zsh zsh-syntax-highlighting
fi

# --- Set zsh as default shell ---
current_shell="$(basename "$SHELL")"
if [[ "$current_shell" != "zsh" ]]; then
  log "Setting zsh as default shell"
  chsh -s "$(which zsh)"
else
  log "zsh already default shell"
fi

# --- Source .zsh_profile from .zshrc ---
touch "$HOME/.zshrc"
add_block_to_file "$HOME/.zshrc" "zsh-profile" '[[ -f ~/.zsh_profile ]] && source ~/.zsh_profile'

# --- History settings ---
read -r -d '' ZSH_HISTORY << 'EOF' || true
HISTFILE=~/.zsh_history
HISTSIZE=100000
SAVEHIST=900000
setopt INC_APPEND_HISTORY
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_REDUCE_BLANKS
setopt HIST_VERIFY
setopt EXTENDED_HISTORY
setopt HIST_IGNORE_SPACE
EOF
add_block_to_file "$HOME/.zshrc" "zsh-history" "$ZSH_HISTORY"

# --- Completion config ---
read -r -d '' ZSH_COMPLETION << 'EOF' || true
zmodload zsh/complist
zstyle ':completion:*' menu select
zstyle ':completion:*:descriptions' format '%F{yellow}-- %d --%f'
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}' 'r:|[._-]=* r:|=*'
autoload -Uz compinit && compinit
EOF
add_block_to_file "$HOME/.zshrc" "zsh-completion" "$ZSH_COMPLETION"

# --- Keybindings ---
add_block_to_file "$HOME/.zshrc" "zsh-keybindings" '# Ctrl+g: fuzzy cd into projects
bindkey -s "^g" "cd \"\$(find ~/projects -type d -maxdepth 2 | fzf)\"\n"'

log "Done - restart terminal or run: exec zsh"
