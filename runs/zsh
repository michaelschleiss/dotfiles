#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/lib"

log() {
  echo "[zsh] $*"
}

os_name="$(uname -s)"

# --- Install zsh + plugins (Linux only, macOS has zsh built-in) ---
if [[ "$os_name" == "Linux" ]]; then
  log "Installing zsh and plugins"
  sudo apt-get update -qq
  sudo apt-get install -qq -y zsh zsh-syntax-highlighting
fi

# --- Set zsh as default shell ---
current_shell="$(basename "$SHELL")"
if [[ "$current_shell" != "zsh" ]]; then
  log "Setting zsh as default shell"
  chsh -s "$(which zsh)"
else
  log "zsh already default shell"
fi

# --- History settings ---
read -r -d '' ZSH_HISTORY << 'EOF' || true
HISTFILE=~/.zsh_history
HISTSIZE=100000
SAVEHIST=900000
setopt INC_APPEND_HISTORY
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_REDUCE_BLANKS
setopt HIST_VERIFY
setopt EXTENDED_HISTORY
setopt HIST_IGNORE_SPACE
EOF
add_block_to_file "$HOME/.zshrc" "zsh-history" "$ZSH_HISTORY"

# --- Completion config ---
read -r -d '' ZSH_COMPLETION << 'EOF' || true
zmodload zsh/complist
zstyle ':completion:*' menu select
zstyle ':completion:*:descriptions' format '%F{yellow}-- %d --%f'
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}' 'r:|[._-]=* r:|=*'
autoload -Uz compinit && compinit
EOF
add_block_to_file "$HOME/.zshrc" "zsh-completion" "$ZSH_COMPLETION"

# --- Aliases ---
read -r -d '' ZSH_ALIASES << 'EOF' || true
alias rsync="rsync -ahr --partial --partial-dir=/tmp/.rsync-partial --info=progress2 --no-inc-recursive -e 'ssh -T -o Compression=no' -c"
alias cat='bat --paging=never'
EOF
add_block_to_file "$HOME/.zshrc" "zsh-aliases" "$ZSH_ALIASES"

# --- direnv hook ---
add_block_to_file "$HOME/.zshrc" "direnv" 'eval "$(direnv hook zsh)"'

# --- fzf integration ---
read -r -d '' ZSH_FZF << 'EOF' || true
if [[ -f /opt/homebrew/opt/fzf/shell/key-bindings.zsh ]]; then
  source /opt/homebrew/opt/fzf/shell/key-bindings.zsh
  source /opt/homebrew/opt/fzf/shell/completion.zsh
elif [[ -f ~/.fzf.zsh ]]; then
  source ~/.fzf.zsh
fi
bindkey '^G' fzf-cd-widget
EOF
add_block_to_file "$HOME/.zshrc" "fzf" "$ZSH_FZF"

# --- Go ---
read -r -d '' ZSH_GO << 'EOF' || true
export GOPATH=~/.go
export PATH=$PATH:~/.go/bin
EOF
add_block_to_file "$HOME/.zshrc" "go" "$ZSH_GO"

# --- Keybindings ---
add_block_to_file "$HOME/.zshrc" "zsh-keybindings" '# Ctrl+g: fuzzy cd into projects
bindkey -s "^g" "cd \"\$(find ~/projects -type d -maxdepth 2 | fzf)\"\n"'

log "Done - restart terminal or run: exec zsh"
