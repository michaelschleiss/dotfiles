#!/bin/bash
# Shared helpers for runs/ scripts

# Cross-platform sed -i (macOS requires '' argument, Linux doesn't)
_sed_i() {
    if [[ "$(uname -s)" == "Darwin" ]]; then
        sed -i '' "$@"
    else
        sed -i "$@"
    fi
}

# Add a block to a file if not already present (idempotent)
# Usage: add_block_to_file <file> <marker_name> <content>
# Example: add_block_to_file ~/.zsh_profile "my-tool" "alias foo='bar'"
add_block_to_file() {
    local file="$1"
    local name="$2"
    local content="$3"
    local marker="# >>> $name >>>"
    local marker_end="# <<< $name <<<"

    if grep -q "$marker" "$file" 2>/dev/null; then
        # Extract existing block content and compare
        local existing
        existing=$(sed -n "/$marker/,/$marker_end/p" "$file" | sed '1d;$d')
        if [[ "$existing" == "$content" ]]; then
            echo "âœ“ $name already in $file"
            return 0
        fi
        echo "ðŸ“ Updating $name in $file..."
        _sed_i "/$marker/,/$marker_end/d" "$file"
    else
        echo "ðŸ“ Adding $name to $file..."
    fi

    cat >> "$file" <<EOF

$marker
$content
$marker_end
EOF
    echo "âœ“ Added $name"
}

# Remove a block from a file by marker name
# Usage: remove_block_from_file <file> <marker_name>
remove_block_from_file() {
    local file="$1"
    local name="$2"
    local marker="# >>> $name >>>"
    local marker_end="# <<< $name <<<"

    if ! grep -q "$marker" "$file" 2>/dev/null; then
        return 0
    fi

    echo "ðŸ—‘  Removing $name from $file..."
    _sed_i "/$marker/,/$marker_end/d" "$file"
    echo "âœ“ Removed $name"
}
