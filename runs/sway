#!/usr/bin/env bash
set -euo pipefail

# Sway window manager setup (Wayland)

log() {
  echo "[sway] $*"
}

os_name="$(uname -s)"

if [[ "$os_name" != "Linux" ]]; then
  log "Sway is Linux-only, skipping"
  exit 0
fi

log "Installing sway and dependencies"
sudo apt-get update -qq
sudo apt-get install -qq -y \
  sway \
  swaylock \
  swayidle \
  swaybg \
  waybar \
  fuzzel \
  wl-clipboard \
  sway-notification-center \
  grim \
  slurp \
  brightnessctl \
  playerctl \
  pavucontrol \
  network-manager-gnome \
  xdg-desktop-portal-wlr \
  xdg-desktop-portal-gtk \
  pipewire \
  pipewire-pulse \
  wireplumber \
  fonts-font-awesome \
  nvidia-prime \
  kanshi # auto-switches display profiles on monitor plug/unplug

# Hybrid GPU setup (Intel + Nvidia)
if lspci | grep -qi nvidia && lspci | grep -qi "vga.*intel"; then
  log "Hybrid GPU detected (Intel + Nvidia)"

  # Find Intel GPU card
  intel_card=""
  for card in /sys/class/drm/card*/device/driver; do
    if [[ -L "$card" ]] && readlink "$card" | grep -q i915; then
      intel_card="/dev/dri/$(basename $(dirname $(dirname $card)))"
      break
    fi
  done

  if [[ -n "$intel_card" ]]; then
    log "Intel GPU at $intel_card"

    # Set WLR_DRM_DEVICES for Wayland compositors
    mkdir -p ~/.config/environment.d
    cat > ~/.config/environment.d/gpu.conf << EOF
# Use Intel GPU for Wayland compositors on hybrid systems
WLR_DRM_DEVICES=$intel_card
EOF
    log "Created ~/.config/environment.d/gpu.conf"

    # Create system session file with --unsupported-gpu flag
    # GDM only reads from /usr/share/wayland-sessions/, not ~/.local/share/
    sudo tee /usr/share/wayland-sessions/sway-hybrid.desktop > /dev/null << 'EOF'
[Desktop Entry]
Name=Sway (Hybrid GPU)
Comment=Sway on hybrid GPU system
Exec=sway --unsupported-gpu
Type=Application
DesktopNames=sway
EOF
    log "Created /usr/share/wayland-sessions/sway-hybrid.desktop"
  else
    log "Warning: Could not find Intel GPU card device"
  fi
fi

log "Done - logout and select 'Sway' at login screen"
