#!/usr/bin/env bash
set -euo pipefail

# ThinkPad P16v specific configuration
# - Fixes brightness function keys via GRUB kernel parameter
# - Adds user to video group for brightnessctl without sudo

log() {
  echo "[p16v] $*"
}

# Only run on Linux
if [[ "$(uname -s)" != "Linux" ]]; then
  log "Skipping: not Linux"
  exit 0
fi

# Only run on ThinkPad P16v
product_family=$(cat /sys/class/dmi/id/product_family 2>/dev/null || echo "")
if [[ "$product_family" != *"ThinkPad P16v"* ]]; then
  log "Skipping: not a ThinkPad P16v (detected: $product_family)"
  exit 0
fi

log "Detected: $product_family"

# --- Brightness keys fix (GRUB kernel parameter) ---
# acpi_osi='Windows 2021' makes BIOS pass brightness/volume keys to OS
# while keeping touchpad working (acpi_osi=Linux breaks the touchpad)
GRUB_FILE="/etc/default/grub"
PARAM="acpi_osi=! acpi_osi='Windows 2021'"

if [[ -f "$GRUB_FILE" ]]; then
  if grep -q "acpi_osi=" "$GRUB_FILE"; then
    log "GRUB already has acpi_osi parameter - check it manually"
    grep "GRUB_CMDLINE_LINUX_DEFAULT" "$GRUB_FILE"
  else
    log "Adding $PARAM to GRUB for brightness/volume keys"
    sudo cp "$GRUB_FILE" "$GRUB_FILE.bak"
    sudo sed -i "s/GRUB_CMDLINE_LINUX_DEFAULT=\"/GRUB_CMDLINE_LINUX_DEFAULT=\"$PARAM /" "$GRUB_FILE"
    sudo update-grub
    log "Reboot required for brightness/volume keys to work"
  fi
else
  log "Warning: $GRUB_FILE not found"
fi

# --- Video group for brightnessctl without sudo ---
if groups "$USER" | grep -qw video; then
  log "User already in video group"
else
  log "Adding $USER to video group"
  sudo usermod -aG video "$USER"
  log "Logout/login required for video group"
fi

log "Done"
