#!/usr/bin/env bash
set -euo pipefail

# Base system setup for a fresh install
# Run this first before other scripts

log() {
  echo "[base] $*"
}

os_name="$(uname -s)"

# --- Homebrew (macOS) ---
if [[ "$os_name" == "Darwin" ]]; then
  if command -v brew &>/dev/null; then
    log "Homebrew already installed"
  else
    log "Installing Homebrew"
    NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" >/dev/null
  fi
fi

# --- Essential tools ---
log "Installing essential packages"
if [[ "$os_name" == "Darwin" ]]; then
  brew install -q git curl wget aria2 pkg-config dua-cli
  brew install -q --cask nikitabobko/tap/aerospace
  brew install -q --cask xquartz
elif [[ "$os_name" == "Linux" ]]; then
  sudo apt-get update -qq
  sudo apt-get install -qq -y \
    git \
    curl \
    wget \
    aria2 \
    build-essential \
    pkg-config \
    unzip \
    htop \
    ninja-build \
    cmake \
    openssh-server \
    avahi-utils `# mDNS/Bonjour CLI tools (avahi-browse, avahi-resolve)` \
    python3-pip \
    python3-venv
  sudo systemctl enable --now ssh -q
  # Install Node.js 22 LTS via NodeSource (apt version is too old)
  if ! command -v node &>/dev/null; then
    log "Installing Node.js 22 LTS via NodeSource"
    curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
    sudo apt-get install -qq -y nodejs
  fi
  # Install Rust via rustup (apt version is too old)
  if ! command -v rustup &>/dev/null; then
    log "Installing Rust via rustup"
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y -q
  fi
  # Install dua-cli via cargo (not in apt)
  if ! command -v dua &>/dev/null; then
    log "Installing dua-cli"
    "$HOME/.cargo/bin/cargo" install dua-cli -q
  fi
fi

# --- direnv (per-directory env vars) ---
if command -v direnv &>/dev/null; then
  log "direnv already installed"
else
  log "Installing direnv"
  if [[ "$os_name" == "Darwin" ]]; then
    brew install direnv
  elif [[ "$os_name" == "Linux" ]]; then
    sudo apt-get install -qq -y direnv
  fi
fi

# --- Pixi (fast package manager for Python/ML) ---
if command -v pixi &>/dev/null; then
  log "Pixi already installed"
else
  log "Installing Pixi"
  curl -fsSL https://pixi.sh/install.sh | bash -s -- --quiet >/dev/null 2>&1
fi

# --- Mutagen (real-time file sync for remote dev) ---
if command -v mutagen &>/dev/null; then
  log "Mutagen already installed"
else
  log "Installing Mutagen"
  if [[ "$os_name" == "Darwin" ]]; then
    brew install -q mutagen-io/mutagen/mutagen
  elif [[ "$os_name" == "Linux" ]]; then
    # Download latest release for Linux
    curl -fsSL https://github.com/mutagen-io/mutagen/releases/latest/download/mutagen_linux_amd64_v0.18.1.tar.gz | tar -xz -C /tmp
    sudo mv /tmp/mutagen /usr/local/bin/
  fi
fi

# --- Ghostty terminal ---
if command -v ghostty &>/dev/null; then
  log "Ghostty already installed"
else
  if [[ "$os_name" == "Darwin" ]]; then
    log "Installing Ghostty (brew cask)"
    brew install -q --cask ghostty
  elif [[ "$os_name" == "Linux" ]]; then
    log "Installing Ghostty (.deb from ghostty-ubuntu)"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/mkasberg/ghostty-ubuntu/HEAD/install.sh)"
  fi
fi

# --- Brave browser (Linux only, macOS has Safari) ---
if [[ "$os_name" == "Linux" ]]; then
  if command -v brave-browser &>/dev/null; then
    log "Brave already installed"
  else
    log "Installing Brave (apt)"
    sudo curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg \
      https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
    echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main" \
      | sudo tee /etc/apt/sources.list.d/brave-browser-release.list >/dev/null
    sudo apt-get update -qq
    sudo apt-get install -qq -y brave-browser
  fi
fi

log "Done"
