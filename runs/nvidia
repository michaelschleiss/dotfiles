#!/usr/bin/env bash
set -euo pipefail

# NVIDIA driver setup using CUDA repo (nvidia-open for Blackwell GPUs)
#
# On hybrid laptops:
# - Display: Intel GPU (configured via WLR_DRM_DEVICES in runs/sway)
# - Compute: Nvidia GPU (CUDA/PyTorch/TensorFlow)

log() {
  echo "[nvidia] $*"
}

have() {
  command -v "$1" >/dev/null 2>&1
}

get_ubuntu_version() {
  if [[ -f /etc/os-release ]]; then
    # shellcheck disable=SC1091
    source /etc/os-release
    echo "${VERSION_ID//./}"
  else
    echo ""
  fi
}

check_nvidia_gpu() {
  if ! lspci | grep -qi nvidia; then
    echo "No NVIDIA GPU detected. Exiting." >&2
    exit 1
  fi
}

remove_existing_nvidia() {
  log "Removing existing NVIDIA packages..."
  sudo apt-get remove --purge -qq -y 'nvidia-*' 'libnvidia-*' >/dev/null 2>&1 || true
  sudo apt-get autoremove -qq -y >/dev/null 2>&1 || true
}

install_cuda_keyring() {
  local ubuntu_ver="$1"
  local keyring_url="https://developer.download.nvidia.com/compute/cuda/repos/ubuntu${ubuntu_ver}/x86_64/cuda-keyring_1.1-1_all.deb"
  local tmpfile="/tmp/cuda-keyring.deb"

  log "Downloading CUDA keyring for Ubuntu ${ubuntu_ver}..."
  curl -fsSL "${keyring_url}" -o "${tmpfile}"

  log "Installing CUDA keyring..."
  sudo dpkg -i "${tmpfile}" >/dev/null
  rm -f "${tmpfile}"

  sudo apt-get update -qq
}

install_nvidia_driver() {
  log "Installing NVIDIA open kernel modules (required for Blackwell GPUs)..."
  sudo apt-get install -qq -y nvidia-open >/dev/null
}

install_nvidia_container_toolkit() {
  if dpkg -l | grep -q nvidia-container-toolkit; then
    log "NVIDIA Container Toolkit already installed"
    return 0
  fi

  log "Installing NVIDIA Container Toolkit for Docker GPU support..."

  # Add nvidia-container-toolkit repository
  curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
  curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list

  sudo apt-get update -qq
  sudo apt-get install -qq -y nvidia-container-toolkit

  # Configure Docker to use nvidia runtime
  sudo nvidia-ctk runtime configure --runtime=docker
  sudo systemctl restart docker

  log "NVIDIA Container Toolkit installed and Docker configured"
}

verify_installation() {
  log "Verify after reboot with: nvidia-smi"
  log "Test Docker GPU access with: docker run --rm --gpus all nvidia/cuda:12.6.0-base-ubuntu22.04 nvidia-smi"
}

main() {
  local os_name
  os_name="$(uname -s)"

  if [[ "${os_name}" != "Linux" ]]; then
    echo "This script only supports Linux." >&2
    exit 1
  fi

  local ubuntu_ver
  ubuntu_ver="$(get_ubuntu_version)"

  if [[ -z "${ubuntu_ver}" ]]; then
    echo "Could not detect Ubuntu version." >&2
    exit 1
  fi

  log "Detected Ubuntu ${ubuntu_ver}"

  check_nvidia_gpu

  # Check if nvidia driver is already installed
  if have nvidia-smi && nvidia-smi >/dev/null 2>&1; then
    log "NVIDIA driver already installed and working"
  else
    log "Installing NVIDIA driver..."
    remove_existing_nvidia
    install_cuda_keyring "${ubuntu_ver}"
    install_nvidia_driver
    log "Driver installed - reboot required before container toolkit will work"
  fi

  # Enable suspend/resume/hibernate services (required when
  # PreserveVideoMemoryAllocations is set, otherwise suspend fails with -EIO)
  log "Enabling NVIDIA power management services..."
  sudo systemctl enable nvidia-suspend.service nvidia-resume.service nvidia-hibernate.service

  install_nvidia_container_toolkit
  verify_installation

  log "Done!"
}

main "$@"
